(function(a){a.extend({tableDnD:new function(){this.defaults={buttonState:"",containerID:null,dragClass:"tDnD_whileDrag",dragHandle:null,dragStyles:{color:"purple","font-style":"italic"},dropStyles:null,onAllowDrop:null,onDragStart:null,onDrop:null,onRowsChanged:null,filterRegexp:null};this.construct=function(s){var t={currentTable:null,dragBody:null,dragObject:null,bound:false,prepare:false,dragging:false,ptrOffset:null,firstY:0,oldY:0,upid:0,dnid:0};this.each(function(){var w=this.tBodies;if(!w){return}var z=0;for(var x=0;x<w.length;x++){z+=w[x].rows.length;if(z>1){break}}if(z<2){return}var v={};a.extend(v,t,a.tableDnD.defaults,s||{});v.currentTable=this;a.data(this,"tDnDconfig",v);var u;if(v.containerID){u=a("#"+v.containerID);if(u.length>0){var y=u.css("overflow");if(!(y=="auto"||y=="scroll")){v.containerID=null}}}if(!v.containerID){u=a(this).parent();y=u.css("overflow");if((y=="auto"||y=="scroll")){v.containerID=u.attr("id");if(!v.containerID){v.containerID="tDnDcontainerID";u.attr("id",v.containerID)}}}if(a.fn.jquery>="1.7"){a(this).on("mouseover.tdnd","tbody",v,l).on("mouseout.tdnd","tbody",v,o)}else{for(x=0;x<w.length;x++){a(w[x]).bind("mouseover.tdnd",v,l).bind("mouseout.tdnd",v,o)}}});return this};this.mapTables=function(){var s="";this.each(function(){s+=e(this)});return s};function e(v){var t=a.data(v,"tDnDconfig");var s={};var u=1;a(v).find("tr").each(function(){var y=a(this);var w=y.attr("id")||y.attr("name")||"row"+u;if(!t||!t.filterRegexp||id.match(t.filterRegexp)!==null){var z={};var x=1;y.each(function(){var A=a(this);var B=[];A.children().each(function(){var D=a(this);var E=D.attr("value");if(typeof E!=="undefined"&&E!==false){B[B.length]=E}else{B[B.length]=D.text()}});var C=A.attr("id")||A.attr("name")||"col"+x;switch(B.length){case 0:z[C]="<empty>";break;case 1:z[C]=B[0];break;default:z[C]=B;break}x++});s[w]=z}u++});return s}function i(s){if(s.pageX||s.pageY){return{x:s.pageX,y:s.pageY}}var t=(document.documentElement&&document.documentElement.scrollLeft!==null)?document.documentElement:document.body;return{x:s.clientX+t.scrollLeft,y:s.clientY+t.scrollTop}}function n(v,u){u=u||window.event;var t=r(v);var s=i(u);return{x:s.x-t.x,y:s.y-t.y}}function r(u){var t=0;var s=0;if(u.offsetHeight===0){if(u.firstChild){u=u.firstChild}}while(u.offsetParent){t+=u.offsetLeft;s+=u.offsetTop;u=u.offsetParent}t+=u.offsetLeft;s+=u.offsetTop;return{x:t,y:s}}function q(){var s=0;if(window.pageYOffset){s=window.pageYOffset}else{if(window.scrollY){s=window.scrollY}else{var u;s=(((u=document.documentElement)||(u=document.body.parentNode))&&typeof u.ScrollTop=="number")?u.ScrollTop:document.body.ScrollTop}}return s}function k(){if(window.innerHeight&&window.scrollMaxY){return window.scrollMaxY}var s=(window.innerHeight)?window.innerHeight:document.body.clientHeight;if(document.body.scrollHeight>document.body.offsetHeight){return document.body.scrollHeight-s}else{return document.body.offsetHeight-s}}function j(u,y,x,s){var w;var z;if(y){var A=q();if(x){if(A>0){w=-1}else{s.upid=0;return}}else{z=k();if(A<z){w=1}else{s.dnid=0;return}}window.scrollBy(0,w)}else{w=a(u).scrollTop();if(x){if(w>0){w-=1}else{s.upid=0;return}}else{z=u.scrollHeight-u.clientHeight;if(w<z){w+=1}else{s.dnid=0;return}}u.scrollTop(w)}var v=setTimeout(function(){j(u,y,x,s)},20);if(x){s.upid=v}else{s.dnid=v}}function p(s){if(s.upid){window.clearTimeout(s.upid);s.upid=0}if(s.dnid){window.clearTimeout(s.dnid);s.dnid=0}}function g(v,t){if(t.dropStyles){var s={};for(var u in t.dropStyles){s[u]=""}a(v).css(s)}if(t.dragClass){a(v).addClass(t.dragClass)}if(t.dragStyles){a(v).css(t.dragStyles)}}function d(v,t){if(t.dragStyles){var s={};for(var u in t.dragStyles){s[u]=""}a(v).css(s)}if(t.dragClass){a(v).removeClass(t.dragClass)}}function c(y){var t=y.data;if(t.buttonState){var w;if(y.which===null){w=(y.button<2)?"0":((y.button===4)?"1":"2")}else{w=(y.which<2)?"0":((y.which===2)?"1":"2")}if(t.buttonState.indexOf(w)===-1){return false}if(t.buttonState.indexOf("shift")!==-1&&!y.shiftKey){return false}if(t.buttonState.indexOf("ctrl")!==-1&&!y.ctrlKey){return false}if(t.buttonState.indexOf("alt")!==-1&&!y.altKey){return false}if(t.buttonState.indexOf("meta")!==-1&&!y.metaKey){return false}}var x=y.target||y.srcElement||y.originalTarget;var v=x.nodeName.toLowerCase();switch(v){case"td":case"tr":break;case"tbody":return false;default:x=a(x).closest("td");if(x.length===0){return false}v="td";break}var z;var s;if(t.dragHandle){var u=a("td."+t.dragHandle,x);if(u.length>0){z=u[0].parentNode;if(!a(z).hasClass("nodrag")){s=a(z).parent("tbody")[0];if(s!==undefined){return{tb:s,ob:z}}}}}else{if(v=="td"){z=a(x).parent("tr")[0];if(z===undefined){return false}}else{z=x}if(!a(z).hasClass("nodrag")){s=a(z).parent("tbody")[0];if(s!==undefined){return{tb:s,ob:z}}}}return false}function l(t){var s=t.data;if(!s.draqgging){if(a.fn.jquery>="1.7"){a(this).on("mousemove.tdnd",s,h)}else{a(this).bind("mousemove.tdnd",s,h)}}return true}function o(u){var v=a(this);var t=a.fn.jquery;var s=u.data;if(!s.dragging){s.currentTable.style.cursor="default";if(t>="1.7"){v.off("mousemove.tdnd",h)}else{v.unbind("mousemove.tdnd",h)}}if(s.bound){if(t>="1.7"){v.off("mousedown.tdnd",f).off("dblclick.tdnd",b)}else{v.unbind("mousedown.tdnd",f).unbind("dblclick.tdnd",b)}s.bound=false}return true}function h(N){var x=N.data;var P=c(N);if(!x.prepare){if(P){if(!x.bound){x.currentTable.style.cursor="crosshair";var L=a.fn.jquery;if(L>="1.7"){$this.on("mousedown.tdnd",x,f).on("dblclick.tdnd",x,b)}else{if(L>="1.4"){a(this).bind("mousedown.tdnd",x,f).bind("dblclick.tdnd",x,b)}else{a(this).bind("mousedown.tdnd",x,f)}}x.bound=true}}else{if(x.bound&&!x.dragging){x.currentTable.style.cursor="default";if(a.fn.jquery>="1.7"){a(this).off("mousedown.tdnd",f).off("dblclick.tdnd",b)}else{a(this).unbind("mousedown.tdnd",f).unbind("dblclick.tdnd",b)}x.bound=false}}return true}var J=i(N);if(Math.abs(J.y-x.firstY)<=3){return false}if(!x.dragging){if(P){if(x.dragBody){if(x.dragBody!=P.tb){a.each(x.dragObject,function(){d(this,x)});x.dragObject=null;x.dragBody=P.tb}}else{x.dragBody=P.tb}if(x.dragObject){if(a.inArray(P.ob,x.dragObject)===-1){x.dragObject[x.dragObject.length]=P.ob;g(P.ob,x)}}else{x.dragObject=[P.ob];g(P.ob,x)}}if(x.dragObject===null){m(N);return true}a.unique(x.dragObject);var I=(P)?P.ob:x.dragObject[0];x.ptrOffset=n(I,N);x.dragging=true;x.oldY=x.firstY-x.ptrOffset.y;if(x.onDragStart){x.onDragStart(table,x.dragObject)}x.currentTable.style.cursor="row-resize";return true}var s;var u;var E=false;if(x.containerID){var F=a("#"+x.containerID);s=F.offset().top;if(J.y<s+5){if(x.upid===0){j(F[0],false,true,x)}E=true}else{u=s+F.outerHeight(true);if(J.y>u-5){if(x.dnid===0){j(F[0],false,false,x)}E=true}}}if(!E){s=q();if(J.y<s+5){if(x.upid===0){j(window,true,true,x)}E=true}else{u=s+a(window).height();if(J.y>u-5){if(x.dnid===0){j(window,true,false,x)}E=true}}}if(!E){p(x)}var C=J.y-x.ptrOffset.y;if(C!=x.oldY){var G=(C<x.oldY);var M=null;var H=a("> tr",x.dragBody);var K;for(K=0;K<H.length;K++){var B=H[K];var Q;var t;if(B.offsetHeight>0){Q=r(B).y;t=parseInt(B.offsetHeight,10)/2}else{Q=r(B.firstChild).y;t=parseInt(B.firstChild.offsetHeight,10)/2}if((C>(Q-t))&&(C<(Q+t))){if(a.inArray(B,x.dragObject)===-1){if(x.onAllowDrop){if(x.onAllowDrop(x.dragObject,B)){M=B}}else{if(!a(B).hasClass("nodrop")){M=B}}}break}}if(M){var v=[];a.each(H,function(y){if(a(this).hasClass("nodrop")&&a.inArray(this,x.dragObject)==-1){v[v.length]=[y,this]}});if(G){a.each(x.dragObject,function(){if(this!=M){a(this).insertBefore(M)}else{var y=a(this).next();if(y.length){M=y[0]}}})}else{a.each(x.dragObject,function(){if(this!=M){a(this).insertAfter(M);M=this}else{var y=a(this).prev();if(y.length){M=y[0]}}})}var A=a("> tr",x.dragBody).eq(0);a.each(v,function(){if(this[1]!=A[0]){a(this[1]).insertBefore(A)}});var z=0;for(var O=0;O<v.length;O++){var w=v[O][0];if(w>z){var D=a("> tr",x.dragBody);a(D[z]).insertAfter(a(D[w]))}else{z++}}if(x.onRowsChanged){x.onRowsChanged(this,x.dragObject,M)}}x.oldY=C}return false}function f(t){var s=t.data;s.prepare=true;s.firstY=i(t).y;if(a.fn.jquery>="1.7"){a(document).on("mouseup.tdnd",s,m)}else{a(document).bind("mouseup.tdnd",s,m)}return false}function m(t){var s=t.data;if(a.fn.jquery>="1.7"){a(document).off("mouseup.tdnd",m)}else{a(document).unbind("mouseup.tdnd",m)}s.prepare=false;s.firstY=0;if(s.dragging){if(s.dragObject){p(s);s.oldY=0;a.each(s.dragObject,function(){d(this,s)});if(s.dropStyles){a.each(s.dragObject,function(){a(this).css(s.dropStyles)})}s.currentTable.style.cursor="crosshair";if(s.onDrop){s.onDrop(s.currentTable,s.dragObject)}s.dragObject=null;s.dragBody=null}s.dragging=false;return false}}function b(u){var v=c(u);if(!v){return true}var t=u.data;if(t.dragBody){if(t.dragBody!=v.tb){a.each(t.dragObject,function(){d(this,t)});t.dragObject=null;t.dragBody=v.tb}}else{t.dragBody=v.tb}if(t.dragObject){var s=a.inArray(v.ob,t.dragObject);if(s!==-1){d(t.dragObject[s],t);if(t.dragObject.length==1){t.dragObject=null}else{t.dragObject.splice(s,1)}}else{if(!a(v.ob).hasClass("nodrag")){t.dragObject[t.dragObject.length]=v.ob;g(v.ob,t)}}}else{if(!a(v.ob).hasClass("nodrag")){t.dragObject=[v.ob];g(v.ob,t)}}return false}}});a.fn.extend({tableDnD:a.tableDnD.construct})})(jQuery);