(function(a){a.extend({tableDnD:new function(){var o=a.fn.jquery;this.defaults={buttonState:"",containerID:null,dragClass:"tDnD_whileDrag",dragHandle:null,dragStyles:{color:"purple","font-style":"italic"},dropStyles:null,onAllowDrop:null,onDragStart:null,onDrop:null,onRowsChanged:null,filterRegexp:null};this.construct=function(t){var u={currentTable:null,dragBody:null,dragObject:null,bound:false,prepare:false,dragging:false,ptrOffset:null,firstY:0,oldY:0,upid:0,dnid:0,jqge14:false,jqge17:false};this.each(function(){var x=this.tBodies;if(!x){return}var A=0;for(var y=0;y<x.length;y++){A+=x[y].rows.length;if(A>1){break}}if(A<2){return}var w={};a.extend(w,u,a.tableDnD.defaults,t||{});w.currentTable=this;a.data(this,"tDnDconfig",w);var v;if(w.containerID){v=a("#"+w.containerID);if(v.length>0){var z=v.css("overflow");if(!(z=="auto"||z=="scroll")){w.containerID=null}}}if(!w.containerID){v=a(this).parent();z=v.css("overflow");if((z=="auto"||z=="scroll")){w.containerID=v.attr("id");if(!w.containerID){w.containerID="tDnDcontainerID";v.attr("id",w.containerID)}}}w.jqge14=(o>="1.4");w.jqge17=(o>="1.7");if(w.jqge17){a(this).on("mouseover.tdnd","tbody",w,n).on("mouseout.tdnd","tbody",w,h)}else{for(y=0;y<x.length;y++){a(x[y]).bind("mouseover.tdnd",w,n).bind("mouseout.tdnd",w,h)}}});return this};this.mapTables=function(){var t="";this.each(function(){t+=s(this)});return t};function s(w){var u=a.data(w,"tDnDconfig");var t={};var v=1;a(w).find("tr").each(function(){var x=this.getAttribute("id")||this.getAttribute("name")||"row"+v;if(!u||!u.filterRegexp||x.match(u.filterRegexp)!==null){var z={};var y=1;a(this).each(function(){var B=[];a(this).children().each(function(){B[B.length]=(this.hasAttribute("value"))?this.getAttribute("value"):a(this).text()});var D=this.atgetAttribute("id")||this.getAttribute("name")||"col"+y;switch(B.length){case 0:z[D]="<empty>";break;case 1:z[D]=B[0];break;default:var C={};for(var A=0;A<B.length;++A){C[A]=B[A]}z[D]=C;break}y++});t[x]=z}v++});return t}function e(t){if(t.pageX||t.pageY){return{x:t.pageX,y:t.pageY}}var u=(document.documentElement&&document.documentElement.scrollLeft!==null)?document.documentElement:document.body;return{x:t.clientX+u.scrollLeft,y:t.clientY+u.scrollTop}}function k(w,v){v=v||window.event;var u=r(w);var t=e(v);return{x:t.x-u.x,y:t.y-u.y}}function r(v){var u=0;var t=0;if(v.offsetHeight===0){if(v.firstChild){v=v.firstChild}}while(v.offsetParent){u+=v.offsetLeft;t+=v.offsetTop;v=v.offsetParent}u+=v.offsetLeft;t+=v.offsetTop;return{x:u,y:t}}function j(){var u=0;if(window.pageYOffset){u=window.pageYOffset}else{if(window.scrollY){u=window.scrollY}else{var v;u=(((v=document.documentElement)||(v=document.body.parentNode))&&typeof v.ScrollTop=="number")?v.ScrollTop:document.body.ScrollTop}}return u}function d(){if(window.innerHeight&&window.scrollMaxY){return window.scrollMaxY}var t=(window.innerHeight)?window.innerHeight:document.body.clientHeight;if(document.body.scrollHeight>document.body.offsetHeight){return document.body.scrollHeight-t}else{return document.body.offsetHeight-t}}function g(v,z,y,u){var x;var A;if(z){var B=j();if(y){if(B>0){x=-1}else{u.upid=0;return}}else{A=d();if(B<A){x=1}else{u.dnid=0;return}}window.scrollBy(0,x)}else{x=a(v).scrollTop();if(y){if(x>0){x-=1}else{u.upid=0;return}}else{A=v.scrollHeight-v.clientHeight;if(x<A){x+=1}else{u.dnid=0;return}}v.scrollTop(x)}var w=setTimeout(function(){g(v,z,y,u)},20);if(y){u.upid=w}else{u.dnid=w}}function p(t){if(t.upid){window.clearTimeout(t.upid);t.upid=0}if(t.dnid){window.clearTimeout(t.dnid);t.dnid=0}}function i(w,u){if(u.dropStyles){var t={};for(var v in u.dropStyles){t[v]=""}a(w).css(t)}if(u.dragClass){a(w).addClass(u.dragClass)}if(u.dragStyles){a(w).css(u.dragStyles)}}function l(w,u){if(u.dragStyles){var t={};for(var v in u.dragStyles){t[v]=""}a(w).css(t)}if(u.dragClass){a(w).removeClass(u.dragClass)}}function c(z){var u=z.data;if(u.buttonState){var x;if(z.which===null){x=(z.button<2)?"0":((z.button===4)?"1":"2")}else{x=(z.which<2)?"0":((z.which===2)?"1":"2")}if(u.buttonState.indexOf(x)===-1){return false}if(u.buttonState.indexOf("shift")!==-1&&!z.shiftKey){return false}if(u.buttonState.indexOf("ctrl")!==-1&&!z.ctrlKey){return false}if(u.buttonState.indexOf("alt")!==-1&&!z.altKey){return false}if(u.buttonState.indexOf("meta")!==-1&&!z.metaKey){return false}}var y=z.target||z.srcElement||z.originalTarget;var w=y.nodeName.toLowerCase();switch(w){case"td":case"tr":break;case"tbody":case"input":case"select":case"a":return false;default:y=a(y).closest("td");if(y.length===0){return false}w="td";break}var A;var t;if(u.dragHandle){var v=a("td."+u.dragHandle,y);if(v.length>0){A=v[0].parentNode;if(!a(A).hasClass("nodrag")){t=a(A).parent("tbody")[0];if(t!==undefined){return{tb:t,ob:A}}}}}else{if(w=="td"){A=a(y).parent("tr")[0];if(A===undefined){return false}}else{A=y}if(!a(A).hasClass("nodrag")){t=a(A).parent("tbody")[0];if(t!==undefined){return{tb:t,ob:A}}}}return false}function n(u){var t=u.data;if(!t.draqgging){if(t.jqge17){a(this).on("mousemove.tdnd",t,f)}else{a(this).bind("mousemove.tdnd",t,f)}}return true}function h(u){var v=a(this);var t=u.data;if(!t.dragging){t.currentTable.style.cursor="default";if(t.jqge17){v.off("mousemove.tdnd",f)}else{v.unbind("mousemove.tdnd",f)}}if(t.bound){if(t.jqge17){v.off("mousedown.tdnd",m).off("dblclick.tdnd",q)}else{v.unbind("mousedown.tdnd",m).unbind("dblclick.tdnd",q)}t.bound=false}return true}function f(N){var z=N.data;var P=c(N);if(!z.prepare){if(P){if(!z.bound){z.currentTable.style.cursor="crosshair";if(z.jqge17){$this.on("mousedown.tdnd",z,m).on("dblclick.tdnd",z,q)}else{if(z.jqge14){a(this).bind("mousedown.tdnd",z,m).bind("dblclick.tdnd",z,q)}else{a(this).bind("mousedown.tdnd",z,m)}}z.bound=true}}else{if(z.bound&&!z.dragging){z.currentTable.style.cursor="default";if(z.jqge17){a(this).off("mousedown.tdnd",m).off("dblclick.tdnd",q)}else{a(this).unbind("mousedown.tdnd",m).unbind("dblclick.tdnd",q)}z.bound=false}}return true}var K=e(N);if(Math.abs(K.y-z.firstY)<=3){return false}if(!z.dragging){if(P){if(z.dragBody){if(z.dragBody!=P.tb){a.each(z.dragObject,function(){l(this,z)});z.dragObject=null;z.dragBody=P.tb}}else{z.dragBody=P.tb}if(z.dragObject){if(a.inArray(P.ob,z.dragObject)===-1){z.dragObject[z.dragObject.length]=P.ob;i(P.ob,z)}}else{z.dragObject=[P.ob];i(P.ob,z)}}if(z.dragObject===null){b(N);return true}a.unique(z.dragObject);var J=(P)?P.ob:z.dragObject[0];z.ptrOffset=k(J,N);z.dragging=true;z.oldY=z.firstY-z.ptrOffset.y;if(z.onDragStart){z.onDragStart(table,z.dragObject)}z.currentTable.style.cursor="row-resize";return true}var t;var v;var F=false;if(z.containerID){var G=a("#"+z.containerID);t=G.offset().top;if(K.y<t+5){if(z.upid===0){g(G[0],false,true,z)}F=true}else{v=t+G.outerHeight(true);if(K.y>v-5){if(z.dnid===0){g(G[0],false,false,z)}F=true}}}if(!F){t=j();if(K.y<t+5){if(z.upid===0){g(window,true,true,z)}F=true}else{v=t+a(window).height();if(K.y>v-5){if(z.dnid===0){g(window,true,false,z)}F=true}}}if(!F){p(z)}var D=K.y-z.ptrOffset.y;if(D!=z.oldY){var H=(D<z.oldY);var M=null;var I=a("> tr",z.dragBody);var L;for(L=0;L<I.length;L++){var C=I[L];var Q;var u;if(C.offsetHeight>0){Q=r(C).y;u=parseInt(C.offsetHeight,10)/2}else{Q=r(C.firstChild).y;u=parseInt(C.firstChild.offsetHeight,10)/2}if((D>(Q-u))&&(D<(Q+u))){if(a.inArray(C,z.dragObject)===-1){if(z.onAllowDrop){if(z.onAllowDrop(z.dragObject,C)){M=C}}else{if(!a(C).hasClass("nodrop")){M=C}}}break}}if(M){var w=[];a.each(I,function(y){if(a(this).hasClass("nodrop")&&a.inArray(this,z.dragObject)==-1){w[w.length]=[y,this]}});if(H){a.each(z.dragObject,function(){if(this!=M){a(this).insertBefore(M)}else{var y=a(this).next();if(y.length){M=y[0]}}})}else{a.each(z.dragObject,function(){if(this!=M){a(this).insertAfter(M);M=this}else{var y=a(this).prev();if(y.length){M=y[0]}}})}var B=a("> tr",z.dragBody).eq(0);a.each(w,function(){if(this[1]!=B[0]){a(this[1]).insertBefore(B)}});var A=0;for(var O=0;O<w.length;O++){var x=w[O][0];if(x>A){var E=a("> tr",z.dragBody);a(E[A]).insertAfter(a(E[x]))}else{A++}}if(z.onRowsChanged){z.onRowsChanged(this,z.dragObject,M)}}z.oldY=D}return false}function m(u){var t=u.data;t.prepare=true;t.firstY=e(u).y;if(t.jqge17){a(document).on("mouseup.tdnd",t,b)}else{a(document).bind("mouseup.tdnd",t,b)}return false}function b(u){var t=u.data;if(t.jqge17){a(document).off("mouseup.tdnd",b)}else{a(document).unbind("mouseup.tdnd",b)}t.prepare=false;t.firstY=0;if(t.dragging){if(t.dragObject){p(t);t.oldY=0;a.each(t.dragObject,function(){l(this,t)});if(t.dropStyles){a.each(t.dragObject,function(){a(this).css(t.dropStyles)})}t.currentTable.style.cursor="crosshair";if(t.onDrop){t.onDrop(t.currentTable,t.dragObject)}t.dragObject=null;t.dragBody=null}t.dragging=false;return false}}function q(v){var w=c(v);if(!w){return true}var u=v.data;if(u.dragBody){if(u.dragBody!=w.tb){a.each(u.dragObject,function(){l(this,u)});u.dragObject=null;u.dragBody=w.tb}}else{u.dragBody=w.tb}if(u.dragObject){var t=a.inArray(w.ob,u.dragObject);if(t!==-1){l(u.dragObject[t],u);if(u.dragObject.length==1){u.dragObject=null}else{u.dragObject.splice(t,1)}}else{if(!a(w.ob).hasClass("nodrag")){u.dragObject[u.dragObject.length]=w.ob;i(w.ob,u)}}}else{if(!a(w.ob).hasClass("nodrag")){u.dragObject=[w.ob];i(w.ob,u)}}return false}}});a.fn.extend({tableDnD:a.tableDnD.construct})})(jQuery);